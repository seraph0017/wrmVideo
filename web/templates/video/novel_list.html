{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block title %}小说列表 | {{ block.super }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">小说列表</h5>
                <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#createNovelModal">
                    <i class="fas fa-plus"></i> 添加小说
                </button>
            </div>
            <div class="card-body">
                <!-- 搜索表单 -->
                {% if form %}
                <div class="row mb-3">
                    <div class="col-md-12">
                        <form method="get" class="d-flex">
                            <input type="text" name="search" class="form-control me-2" 
                                   placeholder="搜索小说名称或类型..." 
                                   value="{{ request.GET.search }}">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-search"></i> 搜索
                            </button>
                            {% if request.GET.search %}
                                <a href="{% url 'video:novel_list' %}" class="btn btn-outline-secondary ms-2">
                                    <i class="fas fa-times"></i> 清除
                                </a>
                            {% endif %}
                        </form>
                    </div>
                </div>
                {% endif %}
                {% if novels %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>名称</th>
                                <th>字数</th>
                                <th>类型</th>
                                <th>章节数</th>
                                <th>创建时间</th>
                                <th>更新时间</th>
                                <th>AI处理</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for novel in novels %}
                            <tr>
                                <td>{{ novel.id }}</td>
                                <td><a href="{% url 'video:novel_detail' novel.id %}" class="text-decoration-none">{{ novel.name }}</a></td>
                                <td>{{ novel.word_count }}</td>
                                <td>{{ novel.type }}</td>
                                <td>{{ novel.chapters.count }}</td>
                                <td>{{ novel.upload_date|date:"Y-m-d H:i" }}</td>
                                <td>{{ novel.last_modified|date:"Y-m-d H:i" }}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm me-1" data-novel-id="{{ novel.id }}" data-novel-name="{{ novel.name|escapejs }}" onclick="generateWithAI(this.dataset.novelId, this.dataset.novelName)">
                                        <i class="fas fa-magic"></i> 生成
                                    </button>
                                    <button class="btn btn-success btn-sm" data-novel-id="{{ novel.id }}" data-novel-name="{{ novel.name|escapejs }}" onclick="validateWithAI(this.dataset.novelId, this.dataset.novelName)">
                                        <i class="fas fa-check-circle"></i> 校验
                                    </button>
                                </td>
                                <td>
                                    <a href="{% url 'video:novel_detail' novel.id %}" class="btn btn-info btn-sm">
                                        <i class="fas fa-eye"></i> 查看
                                    </a>
                                    <a href="{% url 'video:novel_delete' novel.id %}" class="btn btn-danger btn-sm">
                                        <i class="fas fa-trash"></i> 删除
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">暂无小说数据</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if is_paginated %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page=1">&laquo; 首页</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">上一页</a>
        </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active">
            <span class="page-link">{{ num }}</span>
        </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <li class="page-item">
            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
        </li>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}">下一页</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">末页 &raquo;</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- 创建小说模态窗口 -->
<div class="modal fade" id="createNovelModal" tabindex="-1" aria-labelledby="createNovelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createNovelModalLabel">添加小说</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createNovelForm" method="post" enctype="multipart/form-data" action="{% url 'video:novel_create' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_original_file" class="form-label">上传文件</label>
                        <input type="file" class="form-control" id="id_original_file" name="original_file" accept=".txt,.doc,.docx,.pdf" required>
                        <div class="form-text">支持上传 .txt, .doc, .docx, .pdf 格式的文件，系统将自动提取内容、计算字数并从文件名获取小说名称</div>
                    </div>
                    <div id="uploadProgress" class="progress" style="display: none;">
                        <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">创建</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// 处理表单提交
document.getElementById('createNovelForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = document.getElementById('submitBtn');
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    
    // 显示进度条
    progressDiv.style.display = 'block';
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 创建中...';
    
    // 模拟进度
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 10;
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        if (progress >= 90) {
            clearInterval(progressInterval);
        }
    }, 200);
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressBar.setAttribute('aria-valuenow', 100);
        
        if (response.ok) {
            return response.json().then(data => {
                if (data.success) {
                    // 成功后刷新页面
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    throw new Error(data.message || '创建失败');
                }
            });
        } else {
            return response.text().then(text => {
                throw new Error('创建失败: ' + response.status);
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('创建失败，请重试');
        
        // 重置按钮和进度条
        submitBtn.disabled = false;
        submitBtn.innerHTML = '创建';
        progressDiv.style.display = 'none';
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', 0);
    });
});

// 重置表单当模态窗口关闭时
document.getElementById('createNovelModal').addEventListener('hidden.bs.modal', function () {
    const form = document.getElementById('createNovelForm');
    const submitBtn = document.getElementById('submitBtn');
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    
    form.reset();
    submitBtn.disabled = false;
    submitBtn.innerHTML = '创建';
    progressDiv.style.display = 'none';
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', 0);
});

// AI生成函数
function generateWithAI(novelId, novelName) {
    if (confirm(`确定要对小说「${novelName}」进行AI生成吗？\n\n此操作将：\n1. 自动分析小说内容\n2. 生成章节分割\n3. 提取角色信息\n4. 创建解说文案\n\n处理过程可能需要较长时间，请耐心等待。`)) {
        // 显示处理中状态
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 生成中...';
        
        // 发送AI生成请求
        fetch(`/video/novels/${novelId}/ai-generate/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`AI生成完成！\n\n${data.message}`);
                // 刷新页面以显示更新后的数据
                window.location.reload();
            } else {
                alert(`AI生成失败：${data.message}`);
                // 恢复按钮状态
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('AI生成过程中发生错误，请重试');
            // 恢复按钮状态
            button.disabled = false;
            button.innerHTML = originalContent;
        });
    }
}

// AI校验函数
function validateWithAI(novelId, novelName) {
    if (confirm(`确定要对小说「${novelName}」进行AI校验吗？\n\n此操作将：\n1. 检查章节完整性\n2. 验证角色一致性\n3. 校验解说文案质量\n4. 生成校验报告\n\n校验过程可能需要一些时间。`)) {
        // 显示处理中状态
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 校验中...';
        
        // 发送AI校验请求
        fetch(`/video/novels/${novelId}/ai-validate/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`AI校验完成！\n\n${data.message}`);
                // 刷新页面以显示更新后的数据
                window.location.reload();
            } else {
                alert(`AI校验失败：${data.message}`);
                // 恢复按钮状态
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('AI校验过程中发生错误，请重试');
            // 恢复按钮状态
            button.disabled = false;
            button.innerHTML = originalContent;
        });
    }
}
</script>

<!-- 使用统一的任务组件 -->
{% include 'components/task-components.html' %}

{% endblock %}