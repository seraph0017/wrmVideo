{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load static %}

{% block title %}{{ novel.name }} | {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/task-components.css' %}">
{% endblock %}

{% block extra_head %}
<script src="{% static 'js/task-components.js' %}"></script>
<script src="{% static 'js/task-integration.js' %}"></script>
{% endblock %}

{% block extra_js %}
<script>
// AI操作相关JavaScript函数

/**
 * 显示AI操作状态
 * @param {string} type - 状态类型: 'loading', 'success', 'error'
 * @param {string} message - 状态消息
 */
function showAIStatus(type, message) {
    // 隐藏所有状态提示
    document.getElementById('ai-status').classList.add('d-none');
    document.getElementById('ai-success').classList.add('d-none');
    document.getElementById('ai-error').classList.add('d-none');
    
    // 显示对应的状态提示
    if (type === 'loading') {
        document.getElementById('ai-status-text').textContent = message;
        document.getElementById('ai-status').classList.remove('d-none');
    } else if (type === 'success') {
        document.getElementById('ai-success-text').textContent = message;
        document.getElementById('ai-success').classList.remove('d-none');
    } else if (type === 'error') {
        document.getElementById('ai-error-text').textContent = message;
        document.getElementById('ai-error').classList.remove('d-none');
    }
}

/**
 * AI生成解说文案功能
 */
function generateScript() {
    // 显示参数配置模态框
    showScriptParametersModal();
}

/**
 * 显示AI校验模态框
 */
function showAIValidationModal() {
    const modal = document.getElementById('aiValidationModal');
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// AI校验相关变量
let currentValidationTaskId = null;
let validationLogPollingInterval = null;
let isValidationPaused = false;

/**
 * 执行AI校验
 */
function executeAIValidation() {
    // 获取表单参数
    const form = document.getElementById('aiValidationForm');
    const formData = new FormData(form);
    
    const parameters = {
        check_closeup_length: formData.get('check_closeup_length') === 'true',
        check_total_length: formData.get('check_total_length') === 'true',
        auto_rewrite: formData.get('auto_rewrite') === 'true',
        auto_fix_characters: formData.get('auto_fix_characters') === 'true',
        auto_fix_tags: formData.get('auto_fix_tags') === 'true'
    };
    
    // 获取统一任务组件
    const unifiedComponent = window.taskIntegrationManager?.unifiedComponents.get('ai_validation');
    if (unifiedComponent) {
        unifiedComponent.updateTaskStatus('running', 0, '正在启动校验任务...');
    }
    
    // 显示任务状态（兼容旧版本）
    const statusContainer = document.getElementById('validationTaskStatusContainer');
    const resultContainer = document.getElementById('validationResultContainer');
    const startBtn = document.getElementById('startValidationBtn');
    const stopBtn = document.getElementById('stopValidationTaskBtn');
    
    if (statusContainer) statusContainer.style.display = 'block';
    if (resultContainer) resultContainer.style.display = 'none';
    if (startBtn) startBtn.disabled = true;
    if (stopBtn) stopBtn.style.display = 'inline-block';
    
    // 更新状态（兼容旧版本）
    updateValidationTaskStatus('运行中', 'bg-primary');
    updateValidationProgress(0, '正在启动校验任务...');
    
    fetch('/video/novels/{{ novel.id }}/ai-validation/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            novel_id: '{{ novel.id }}',
            parameters: parameters
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentValidationTaskId = data.task_id;
            document.getElementById('currentValidationTaskId').textContent = currentValidationTaskId;
            
            // 更新统一任务组件
            if (unifiedComponent) {
                unifiedComponent.setTaskId(data.task_id);
                unifiedComponent.updateTaskStatus('running', 5, '任务已启动，正在处理...');
            }
            
            addValidationLogLine('任务已启动，任务ID: ' + currentValidationTaskId);
            // 开始轮询任务状态
            startValidationLogPolling();
            pollValidationStatus(data.task_id);
        } else {
            if (unifiedComponent) {
                unifiedComponent.showTaskError('启动校验失败: ' + data.message);
                unifiedComponent.updateTaskStatus('failed', 0, '启动失败');
            }
            showValidationError('启动校验失败: ' + data.message);
        }
    })
    .catch(error => {
        showValidationError('请求失败: ' + error.message);
        console.error('Error:', error);
    });
}

/**
 * 更新校验任务状态
 */
function updateValidationTaskStatus(status, badgeClass) {
    const statusElement = document.getElementById('validationTaskStatus');
    statusElement.textContent = status;
    statusElement.className = 'badge me-2 ' + badgeClass;
}

/**
 * 更新校验进度
 */
function updateValidationProgress(percentage, statusText) {
    const progressText = document.getElementById('validationTaskProgress');
    progressText.textContent = percentage + '% - ' + statusText;
}

/**
 * 添加校验日志行
 */
function addValidationLogLine(message) {
    const logContent = document.getElementById('validationLogContent');
    const timestamp = new Date().toLocaleTimeString();
    const logLine = document.createElement('div');
    logLine.className = 'log-line';
    logLine.innerHTML = `<span class="text-info">[${timestamp}]</span> ${message}`;
    logContent.appendChild(logLine);
    
    // 自动滚动到底部
    const logContainer = logContent.parentElement;
    logContainer.scrollTop = logContainer.scrollHeight;
}

/**
 * 开始校验日志轮询
 */
function startValidationLogPolling() {
    if (validationLogPollingInterval) {
        clearInterval(validationLogPollingInterval);
    }
    
    validationLogPollingInterval = setInterval(() => {
        if (!isValidationPaused && currentValidationTaskId) {
            fetchValidationTaskLog();
        }
    }, 2000); // 每2秒轮询一次
}

/**
 * 停止校验日志轮询
 */
function stopValidationLogPolling() {
    if (validationLogPollingInterval) {
        clearInterval(validationLogPollingInterval);
        validationLogPollingInterval = null;
    }
}

/**
 * 获取校验任务日志
 */
function fetchValidationTaskLog() {
    if (!currentValidationTaskId) return;
    
    fetch(`/video/get-task-log/${currentValidationTaskId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.logs) {
                // 更新日志显示
                const logContent = document.getElementById('validationLogContent');
                logContent.innerHTML = '';
                
                data.logs.forEach(log => {
                    const logLine = document.createElement('div');
                    logLine.className = 'log-line';
                    logLine.innerHTML = log;
                    logContent.appendChild(logLine);
                });
                
                // 自动滚动到底部
                const logContainer = logContent.parentElement;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        })
        .catch(error => {
            console.error('获取校验日志失败:', error);
        });
}

/**
 * 轮询校验状态
 */
function pollValidationStatus(taskId) {
    const pollInterval = setInterval(() => {
        fetch('/video/novels/{{ novel.id }}/validation-status/' + taskId + '/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'completed') {
                clearInterval(pollInterval);
                stopValidationLogPolling();
                updateValidationTaskStatus('已完成', 'bg-success');
                updateValidationProgress(100, '校验完成');
                addValidationLogLine('校验任务已完成');
                showValidationResult(data.result);
                const startBtn = document.getElementById('startValidationBtn');
                const stopBtn = document.getElementById('stopValidationTaskBtn');
                if (startBtn) startBtn.disabled = false;
                if (stopBtn) stopBtn.style.display = 'none';
                currentValidationTaskId = null;
            } else if (data.status === 'failed') {
                clearInterval(pollInterval);
                stopValidationLogPolling();
                updateValidationTaskStatus('失败', 'bg-danger');
                addValidationLogLine('校验任务失败: ' + (data.error || '未知错误'));
                showValidationError('校验失败: ' + data.error);
                const stopBtn = document.getElementById('stopValidationTaskBtn');
                if (stopBtn) stopBtn.style.display = 'none';
                currentValidationTaskId = null;
            } else {
                // 更新进度
                const progress = data.progress || 0;
                updateValidationProgress(progress, data.status_text || '正在校验...');
                if (data.status_text) {
                    addValidationLogLine(data.status_text);
                }
            }
        })
        .catch(error => {
            clearInterval(pollInterval);
            stopValidationLogPolling();
            updateValidationTaskStatus('错误', 'bg-danger');
            addValidationLogLine('获取状态失败: ' + error.message);
            showValidationError('获取状态失败: ' + error.message);
            currentValidationTaskId = null;
        });
    }, 2000); // 每2秒轮询一次
}

/**
 * 显示校验结果
 */
function showValidationResult(result) {
    const progressContainer = document.getElementById('validationProgressContainer');
    const resultContainer = document.getElementById('validationResultContainer');
    if (progressContainer) progressContainer.style.display = 'none';
    if (resultContainer) resultContainer.style.display = 'block';
    
    let resultHtml = '<div class="alert alert-success"><h6><i class="fas fa-check-circle me-2"></i>校验完成</h6></div>';
    
    if (result.issues && result.issues.length > 0) {
        resultHtml += '<div class="alert alert-warning"><h6><i class="fas fa-exclamation-triangle me-2"></i>发现问题</h6><ul class="mb-0">';
        result.issues.forEach(issue => {
            resultHtml += '<li>' + issue + '</li>';
        });
        resultHtml += '</ul></div>';
    }
    
    if (result.fixes && result.fixes.length > 0) {
        resultHtml += '<div class="alert alert-info"><h6><i class="fas fa-tools me-2"></i>自动修复</h6><ul class="mb-0">';
        result.fixes.forEach(fix => {
            resultHtml += '<li>' + fix + '</li>';
        });
        resultHtml += '</ul></div>';
    }
    
    document.getElementById('validationResultContent').innerHTML = resultHtml;
}

/**
 * 显示校验错误
 */
function showValidationError(errorMessage) {
    const progressContainer = document.getElementById('validationProgressContainer');
    const resultContainer = document.getElementById('validationResultContainer');
    const resultContent = document.getElementById('validationResultContent');
    const startBtn = document.getElementById('startValidationBtn');
    
    if (progressContainer) progressContainer.style.display = 'none';
    if (resultContainer) resultContainer.style.display = 'block';
    if (resultContent) resultContent.innerHTML = 
        '<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i>' + errorMessage + '</div>';
    if (startBtn) startBtn.disabled = false;
}

/**
 * 显示校验日志模态框
 */
function showValidationLogModal() {
    // 使用统一任务日志模态框
    const modal = new bootstrap.Modal(document.getElementById('taskLogModal'));
    modal.show();
    
    // 设置任务类型
    document.getElementById('currentTaskType').textContent = 'AI智能校验';
    
    // 获取统一任务组件
    const taskLogViewer = document.getElementById('taskLogViewer');
    if (!taskLogViewer.querySelector('.unified-task-component')) {
        // 如果还没有初始化统一组件，创建一个
        taskLogViewer.innerHTML = `
            <div class="unified-task-component">
                <div class="task-status-header">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="badge bg-secondary me-2" id="validationTaskStatus">检查中</span>
                            <small class="text-muted">任务ID: <span id="validationCurrentTaskId">-</span></small>
                        </div>
                        <div class="task-progress">
                            <span id="validationTaskProgress">0%</span>
                        </div>
                    </div>
                </div>
                <div class="task-log-container">
                    <div class="log-header d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="fas fa-terminal me-2"></i>任务日志</h6>
                        <div class="log-controls">
                            <button class="btn btn-outline-secondary btn-sm me-1" onclick="clearValidationTaskLog()">
                                <i class="fas fa-trash me-1"></i>清空
                            </button>
                            <button class="btn btn-outline-primary btn-sm me-1" id="validationPauseResumeBtn" onclick="toggleValidationLogPolling()">
                                <i class="fas fa-pause me-1"></i>暂停
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="stopValidationTask()">
                                <i class="fas fa-stop me-1"></i>停止
                            </button>
                        </div>
                    </div>
                    <div class="log-content" id="validationLogContent">
                        <div class="log-line text-muted">正在检查校验任务状态...</div>
                    </div>
                </div>
            </div>
        `;
    } else {
        // 重置现有组件的状态
        document.getElementById('validationLogContent').innerHTML = '<div class="log-line text-muted">正在检查校验任务状态...</div>';
        document.getElementById('validationCurrentTaskId').textContent = currentValidationTaskId || '-';
        updateValidationTaskStatus('检查中', 'bg-secondary');
        document.getElementById('validationTaskProgress').textContent = '0%';
    }
    
    // 如果有当前校验任务，显示其状态
    if (currentValidationTaskId) {
        document.getElementById('validationCurrentTaskId').textContent = currentValidationTaskId;
        addValidationLogLine('发现活跃校验任务，任务ID: ' + currentValidationTaskId);
        if (!isValidationPaused) {
            startValidationLogPolling();
        }
    } else {
        addValidationLogLine('当前没有活跃的校验任务');
    }
}

/**
 * 停止校验任务
 */
function stopValidationTask() {
    if (!currentValidationTaskId) return;
    
    fetch(`/video/stop-task/${currentValidationTaskId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addValidationLogLine('任务已被用户停止');
            updateValidationTaskStatus('已停止', 'bg-warning');
            stopValidationLogPolling();
            const startBtn = document.getElementById('startValidationBtn');
            const stopBtn = document.getElementById('stopValidationTaskBtn');
            if (startBtn) startBtn.disabled = false;
            if (stopBtn) stopBtn.style.display = 'none';
            currentValidationTaskId = null;
        } else {
            addValidationLogLine('停止任务失败: ' + data.message);
        }
    })
    .catch(error => {
        addValidationLogLine('停止任务失败: ' + error.message);
        console.error('停止任务失败:', error);
    });
}

/**
 * 显示解说文案生成参数配置模态框
 */
function showScriptParametersModal() {
    const modal = document.getElementById('scriptParametersModal');
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// 校验日志模态框事件处理
document.addEventListener('DOMContentLoaded', function() {
    // 查看校验日志按钮
    const viewValidationLogBtn = document.getElementById('viewValidationLogBtn');
    if (viewValidationLogBtn) {
        viewValidationLogBtn.addEventListener('click', showValidationLogModal);
    }
    
    // 统一任务组件的事件监听器会在showValidationLogModal中动态绑定
    
    // 停止校验任务按钮（模态框内）
    const stopValidationTaskBtn = document.getElementById('stopValidationTaskBtn');
    if (stopValidationTaskBtn) {
        stopValidationTaskBtn.addEventListener('click', stopValidationTask);
    }
})

// 实时日志相关变量
        let currentTaskId = null;
        let logPollingInterval = null;
        let isPaused = false;
        let scriptLogPollingActive = false;

/**
 * 执行解说文案生成
 */
function executeScriptGeneration() {
    // 获取表单参数
    const form = document.getElementById('scriptParametersForm');
    const formData = new FormData(form);
    
    const parameters = {
        chapters: parseInt(formData.get('chapters')) || 50,
        limit: formData.get('limit') ? parseInt(formData.get('limit')) : null,
        workers: parseInt(formData.get('workers')) || 5,
        min_length: parseInt(formData.get('min_length')) || 1200,
        max_length: parseInt(formData.get('max_length')) || 1700,
        max_retries: parseInt(formData.get('max_retries')) || 3,
        validate_only: formData.get('validate_only') === 'on',
        regenerate: formData.get('regenerate') === 'on'
    };
    
    // 获取统一任务组件
    const unifiedComponent = window.taskIntegrationManager?.unifiedComponents.get('script_generation');
    if (unifiedComponent) {
        unifiedComponent.updateTaskStatus('running', 0, '正在启动解说文案生成任务...');
    }
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('scriptParametersModal'));
    modal.hide();
    
    // 显示实时日志模态框
    showRealTimeLogModal();
    
    fetch('/video/novels/{{ novel.id }}/generate-script/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
             novel_id: '{{ novel.id }}',
             action: 'generate_script',
             parameters: parameters
         })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentTaskId = data.task_id;
            document.getElementById('currentTaskId').textContent = currentTaskId;
            
            // 更新统一任务组件
            if (unifiedComponent) {
                unifiedComponent.setTaskId(data.task_id);
                unifiedComponent.updateTaskStatus('running', 10, '任务已启动，正在生成解说文案...');
            }
            
            updateTaskStatus('运行中', 'bg-primary');
            addLogLine('任务已启动，任务ID: ' + currentTaskId);
            startLogPolling();
            
            // 启动解说文案任务日志轮询
            scriptLogPollingActive = true;
            startScriptLogPolling();
            
            // 更新按钮状态
            updateScriptButtonState(data.task_status);
            // 开始轮询任务状态
            startTaskStatusPolling();
        } else {
            if (unifiedComponent) {
                unifiedComponent.showTaskError('启动解说文案生成失败: ' + data.message);
                unifiedComponent.updateTaskStatus('failed', 0, '启动失败');
            }
            updateTaskStatus('失败', 'bg-danger');
            addLogLine('启动失败：' + data.message, 'error');
            // 如果任务已在进行中，开始轮询
            if (data.task_status === 'generating_script') {
                updateScriptButtonState(data.task_status);
                startTaskStatusPolling();
            }
        }
    })
    .catch(error => {
        updateTaskStatus('错误', 'bg-danger');
        addLogLine('请求失败：' + error.message, 'error');
        console.error('Error:', error);
    });
}

/**
 * 显示实时日志模态框
 */
function showRealTimeLogModal() {
    // 使用统一任务日志模态框
    const modal = new bootstrap.Modal(document.getElementById('taskLogModal'));
    modal.show();
    
    // 设置任务类型
    document.getElementById('currentTaskType').textContent = '解说文案生成';
    
    // 获取统一任务组件
    const taskLogViewer = document.getElementById('taskLogViewer');
    if (!taskLogViewer.querySelector('.unified-task-component')) {
        // 如果还没有初始化统一组件，创建一个
        taskLogViewer.innerHTML = `
            <div class="unified-task-component">
                <div class="task-status-header">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="badge bg-info me-2" id="scriptTaskStatus">准备中</span>
                            <small class="text-muted">任务ID: <span id="scriptCurrentTaskId">-</span></small>
                        </div>
                        <div class="task-progress">
                            <span id="scriptTaskProgress">0%</span>
                        </div>
                    </div>
                </div>
                <div class="task-log-container">
                    <div class="log-header d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="fas fa-terminal me-2"></i>任务日志</h6>
                        <div class="log-controls">
                            <button class="btn btn-outline-secondary btn-sm me-1" onclick="clearScriptTaskLog()">
                                <i class="fas fa-trash me-1"></i>清空
                            </button>
                            <button class="btn btn-outline-primary btn-sm me-1" id="scriptPauseResumeBtn" onclick="toggleScriptLogPolling()">
                                <i class="fas fa-pause me-1"></i>暂停
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="stopScriptTask()">
                                <i class="fas fa-stop me-1"></i>停止
                            </button>
                        </div>
                    </div>
                    <div class="log-content" id="scriptLogContent">
                        <div class="log-line text-muted">正在启动任务...</div>
                    </div>
                </div>
            </div>
        `;
    } else {
        // 重置现有组件的状态
        document.getElementById('scriptLogContent').innerHTML = '<div class="log-line text-muted">正在启动任务...</div>';
        document.getElementById('scriptCurrentTaskId').textContent = '-';
        updateScriptTaskStatus('准备中', 'bg-info');
        document.getElementById('scriptTaskProgress').textContent = '0%';
    }
}

/**
 * 显示任务日志模态框（用于查看历史日志）
 */
function showTaskLogModal() {
    // 使用统一任务日志模态框
    const modal = new bootstrap.Modal(document.getElementById('taskLogModal'));
    modal.show();
    
    // 设置任务类型
    document.getElementById('currentTaskType').textContent = '解说文案生成';
    
    // 获取统一任务组件
    const taskLogViewer = document.getElementById('taskLogViewer');
    if (!taskLogViewer.querySelector('.unified-task-component')) {
        // 如果还没有初始化统一组件，创建一个
        taskLogViewer.innerHTML = `
            <div class="unified-task-component">
                <div class="task-status-header">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="badge bg-secondary me-2" id="scriptTaskStatus">检查中</span>
                            <small class="text-muted">任务ID: <span id="scriptCurrentTaskId">-</span></small>
                        </div>
                        <div class="task-progress">
                            <span id="scriptTaskProgress">0%</span>
                        </div>
                    </div>
                </div>
                <div class="task-log-container">
                    <div class="log-header d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="fas fa-terminal me-2"></i>任务日志</h6>
                        <div class="log-controls">
                            <button class="btn btn-outline-secondary btn-sm me-1" onclick="clearScriptTaskLog()">
                                <i class="fas fa-trash me-1"></i>清空
                            </button>
                            <button class="btn btn-outline-primary btn-sm me-1" id="scriptPauseResumeBtn" onclick="toggleScriptLogPolling()">
                                <i class="fas fa-pause me-1"></i>暂停
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="stopScriptTask()">
                                <i class="fas fa-stop me-1"></i>停止
                            </button>
                        </div>
                    </div>
                    <div class="log-content" id="scriptLogContent">
                        <div class="log-line text-muted">正在检查任务状态...</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 检查是否有当前任务
    fetch('/video/novels/{{ novel.id }}/task-status/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.current_task_id) {
            // 有活跃任务，显示实时日志
            currentTaskId = data.current_task_id;
            document.getElementById('scriptCurrentTaskId').textContent = currentTaskId;
            updateScriptTaskStatus('运行中', 'bg-primary');
            addScriptLogLine('发现活跃任务，任务ID: ' + currentTaskId);
            startScriptLogPolling();
        } else {
            // 没有活跃任务，显示最近的任务状态
            document.getElementById('scriptLogContent').innerHTML = '<div class="log-line text-muted">当前没有活跃任务</div>';
            document.getElementById('scriptCurrentTaskId').textContent = '无';
            
            if (data.task_status === 'script_completed') {
                updateScriptTaskStatus('已完成', 'bg-success');
                addScriptLogLine('最近任务: ' + (data.task_message || '解说文案生成完成'));
            } else if (data.task_status === 'script_failed') {
                updateScriptTaskStatus('失败', 'bg-danger');
                addScriptLogLine('最近任务: ' + (data.task_message || '解说文案生成失败'), 'error');
            } else {
                updateScriptTaskStatus('空闲', 'bg-secondary');
                addScriptLogLine('系统当前空闲，可以开始新任务');
            }
        }
    })
    .catch(error => {
        console.error('获取任务状态失败:', error);
        document.getElementById('scriptLogContent').innerHTML = '<div class="log-line text-danger">获取任务状态失败</div>';
        updateScriptTaskStatus('错误', 'bg-danger');
    });
}

/**
 * 更新任务状态
 */
function updateTaskStatus(status, badgeClass) {
    const statusElement = document.getElementById('taskStatus');
    statusElement.textContent = status;
    statusElement.className = 'badge me-2 ' + badgeClass;
}

/**
 * 更新解说文案任务状态
 */
function updateScriptTaskStatus(status, badgeClass) {
    const statusElement = document.getElementById('scriptTaskStatus');
    if (statusElement) {
        statusElement.textContent = status;
        statusElement.className = 'badge me-2 ' + badgeClass;
    }
}

/**
 * 添加解说文案任务日志行
 */
function addScriptLogLine(message, type = 'info') {
    const logContent = document.getElementById('scriptLogContent');
    if (!logContent) return;
    
    const timestamp = new Date().toLocaleTimeString();
    const logClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-muted';
    
    const logLine = document.createElement('div');
    logLine.className = 'log-line ' + logClass;
    logLine.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
    
    logContent.appendChild(logLine);
    logContent.scrollTop = logContent.scrollHeight;
}

/**
 * 清空解说文案任务日志
 */
function clearScriptTaskLog() {
    const logContent = document.getElementById('scriptLogContent');
    if (logContent) {
        logContent.innerHTML = '<div class="log-line text-muted">日志已清空</div>';
    }
}

/**
 * 切换解说文案日志轮询状态
 */
function toggleScriptLogPolling() {
    const btn = document.getElementById('scriptPauseResumeBtn');
    if (!btn) return;
    
    if (scriptLogPollingActive) {
        // 暂停轮询
        scriptLogPollingActive = false;
        btn.innerHTML = '<i class="fas fa-play me-1"></i>继续';
        btn.className = 'btn btn-outline-success btn-sm me-1';
        addScriptLogLine('日志轮询已暂停', 'info');
    } else {
        // 恢复轮询
        scriptLogPollingActive = true;
        btn.innerHTML = '<i class="fas fa-pause me-1"></i>暂停';
        btn.className = 'btn btn-outline-primary btn-sm me-1';
        addScriptLogLine('日志轮询已恢复', 'info');
        startScriptLogPolling();
    }
}

/**
 * 开始解说文案日志轮询
 */
function startScriptLogPolling() {
    if (!scriptLogPollingActive || !currentTaskId) return;
    
    setTimeout(() => {
        if (!scriptLogPollingActive) return;
        
        fetch(`/video/novels/{{ novel.id }}/task-log/${currentTaskId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.logs && data.logs.length > 0) {
                data.logs.forEach(log => {
                    addScriptLogLine(log.message, log.level);
                });
            }
            
            if (data.progress !== undefined) {
                document.getElementById('scriptTaskProgress').textContent = data.progress + '%';
            }
            
            if (data.status) {
                const statusMap = {
                    'running': { text: '运行中', class: 'bg-primary' },
                    'completed': { text: '已完成', class: 'bg-success' },
                    'failed': { text: '失败', class: 'bg-danger' }
                };
                
                const statusInfo = statusMap[data.status];
                if (statusInfo) {
                    updateScriptTaskStatus(statusInfo.text, statusInfo.class);
                }
                
                if (data.status === 'completed' || data.status === 'failed') {
                    scriptLogPollingActive = false;
                    const btn = document.getElementById('scriptPauseResumeBtn');
                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-play me-1"></i>继续';
                        btn.className = 'btn btn-outline-secondary btn-sm me-1';
                        btn.disabled = true;
                    }
                }
            }
            
            if (scriptLogPollingActive) {
                startScriptLogPolling();
            }
        })
        .catch(error => {
            console.error('获取日志失败:', error);
            addScriptLogLine('获取日志失败: ' + error.message, 'error');
            if (scriptLogPollingActive) {
                startScriptLogPolling();
            }
        });
    }, 2000);
}

/**
 * 停止解说文案任务
 */
function stopScriptTask() {
    if (!currentTaskId) {
        addScriptLogLine('没有活跃任务可以停止', 'error');
        return;
    }
    
    if (confirm('确定要停止当前任务吗？')) {
        fetch(`/video/novels/{{ novel.id }}/stop-task/${currentTaskId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addScriptLogLine('任务停止请求已发送', 'success');
                updateScriptTaskStatus('已停止', 'bg-warning');
                scriptLogPollingActive = false;
            } else {
                addScriptLogLine('停止任务失败: ' + (data.error || '未知错误'), 'error');
            }
        })
        .catch(error => {
            console.error('停止任务失败:', error);
            addScriptLogLine('停止任务失败: ' + error.message, 'error');
        });
    }
}

/**
 * 导出任务日志
 */
function exportTaskLog() {
    const logContent = document.getElementById('scriptLogContent') || document.getElementById('validationLogContent');
    if (!logContent) {
        alert('没有可导出的日志内容');
        return;
    }
    
    const logs = Array.from(logContent.querySelectorAll('.log-line')).map(line => line.textContent).join('\n');
    const blob = new Blob([logs], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `task-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

/**
 * 更新校验任务状态
 */
function updateValidationTaskStatus(status, badgeClass) {
    const statusElement = document.getElementById('validationTaskStatus');
    if (statusElement) {
        statusElement.textContent = status;
        statusElement.className = 'badge me-2 ' + badgeClass;
    }
}

/**
 * 添加校验任务日志行
 */
function addValidationLogLine(message, type = 'info') {
    const logContent = document.getElementById('validationLogContent');
    if (!logContent) return;
    
    const timestamp = new Date().toLocaleTimeString();
    const logClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-muted';
    
    const logLine = document.createElement('div');
    logLine.className = 'log-line ' + logClass;
    logLine.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
    
    logContent.appendChild(logLine);
    logContent.scrollTop = logContent.scrollHeight;
}

/**
 * 清空校验任务日志
 */
function clearValidationTaskLog() {
    const logContent = document.getElementById('validationLogContent');
    if (logContent) {
        logContent.innerHTML = '<div class="log-line text-muted">日志已清空</div>';
    }
}

/**
 * 切换校验日志轮询状态
 */
function toggleValidationLogPolling() {
    const btn = document.getElementById('validationPauseResumeBtn');
    if (!btn) return;
    
    if (!isValidationPaused) {
        // 暂停轮询
        isValidationPaused = true;
        btn.innerHTML = '<i class="fas fa-play me-1"></i>继续';
        btn.className = 'btn btn-outline-success btn-sm me-1';
        addValidationLogLine('日志轮询已暂停', 'info');
        stopValidationLogPolling();
    } else {
        // 恢复轮询
        isValidationPaused = false;
        btn.innerHTML = '<i class="fas fa-pause me-1"></i>暂停';
        btn.className = 'btn btn-outline-primary btn-sm me-1';
        addValidationLogLine('日志轮询已恢复', 'info');
        startValidationLogPolling();
    }
}

/**
 * 启动校验日志轮询
 */
function startValidationLogPolling() {
    if (validationLogPollingInterval) {
        clearInterval(validationLogPollingInterval);
    }
    
    validationLogPollingInterval = setInterval(() => {
        if (!isValidationPaused && currentValidationTaskId) {
            fetchValidationTaskLog(currentValidationTaskId);
        }
    }, 2000);
}

/**
 * 停止校验日志轮询
 */
function stopValidationLogPolling() {
    if (validationLogPollingInterval) {
        clearInterval(validationLogPollingInterval);
        validationLogPollingInterval = null;
    }
}

/**
 * 停止校验任务
 */
function stopValidationTask() {
    if (!currentValidationTaskId) {
        alert('没有正在运行的校验任务');
        return;
    }
    
    fetch(`/api/stop_validation_task/${currentValidationTaskId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addValidationLogLine('任务已停止', 'info');
            updateValidationTaskStatus('已停止', 'badge-secondary');
            stopValidationLogPolling();
            
            // 更新按钮状态
            const stopBtn = document.getElementById('validationStopBtn');
            if (stopBtn) {
                stopBtn.disabled = true;
            }
            
            currentValidationTaskId = null;
        } else {
            addValidationLogLine('停止任务失败: ' + (data.error || '未知错误'), 'error');
        }
    })
    .catch(error => {
        console.error('停止校验任务失败:', error);
        addValidationLogLine('停止任务失败: ' + error.message, 'error');
    });
}

/**
 * 获取校验任务日志
 */
function fetchValidationTaskLog(taskId) {
    fetch(`/api/get_validation_task_log/${taskId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 更新任务状态
                if (data.status) {
                    let badgeClass = 'badge-primary';
                    if (data.status === '已完成') badgeClass = 'badge-success';
                    else if (data.status === '失败') badgeClass = 'badge-danger';
                    else if (data.status === '已停止') badgeClass = 'badge-secondary';
                    
                    updateValidationTaskStatus(data.status, badgeClass);
                    
                    // 如果任务完成或失败，停止轮询
                    if (data.status === '已完成' || data.status === '失败' || data.status === '已停止') {
                        stopValidationLogPolling();
                        const stopBtn = document.getElementById('validationStopBtn');
                        if (stopBtn) {
                            stopBtn.disabled = true;
                        }
                    }
                }
                
                // 更新日志内容
                if (data.logs && data.logs.length > 0) {
                    const logContent = document.getElementById('validationLogContent');
                    if (logContent) {
                        // 清空现有日志
                        logContent.innerHTML = '';
                        
                        // 添加新日志
                        data.logs.forEach(log => {
                            const logType = log.level === 'ERROR' ? 'error' : 
                                          log.level === 'SUCCESS' ? 'success' : 'info';
                            addValidationLogLine(log.message, logType);
                        });
                    }
                }
            }
        })
        .catch(error => {
            console.error('获取校验任务日志失败:', error);
        });
}

/**
 * 添加日志行
 */
function addLogLine(message, type = 'info') {
    const logContent = document.getElementById('logContent');
    const timestamp = new Date().toLocaleTimeString();
    const logClass = type === 'error' ? 'text-danger' : type === 'warning' ? 'text-warning' : 'text-light';
    
    const logLine = document.createElement('div');
    logLine.className = 'log-line ' + logClass;
    logLine.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
    
    logContent.appendChild(logLine);
    
    // 自动滚动到底部
    const logContainer = logContent.parentElement;
    logContainer.scrollTop = logContainer.scrollHeight;
}

/**
 * 开始日志轮询
 */
function startLogPolling() {
    if (logPollingInterval) {
        clearInterval(logPollingInterval);
    }
    
    logPollingInterval = setInterval(() => {
        if (!isPaused && currentTaskId) {
            fetchTaskLog();
        }
    }, 2000); // 每2秒轮询一次
}

/**
 * 获取任务日志
 */
function fetchTaskLog() {
    fetch(`/video/novels/{{ novel.id }}/task-log/?task_id=${currentTaskId}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新日志内容
            if (data.logs && data.logs.length > 0) {
                data.logs.forEach(log => {
                    addLogLine(log.message, log.level);
                });
            }
            
            // 更新任务状态
            if (data.status) {
                const statusMap = {
                    'PENDING': ['等待中', 'bg-warning'],
                    'STARTED': ['运行中', 'bg-primary'],
                    'PROGRESS': ['执行中', 'bg-primary'],
                    'SUCCESS': ['完成', 'bg-success'],
                    'FAILURE': ['失败', 'bg-danger'],
                    'RETRY': ['重试中', 'bg-warning'],
                    'REVOKED': ['已取消', 'bg-secondary']
                };
                
                const [statusText, badgeClass] = statusMap[data.status] || ['未知', 'bg-secondary'];
                updateTaskStatus(statusText, badgeClass);
                
                // 更新进度
                if (data.progress !== undefined) {
                    document.getElementById('taskProgress').textContent = data.progress + '%';
                }
                
                // 如果任务完成或失败，停止轮询
                if (['SUCCESS', 'FAILURE', 'REVOKED'].includes(data.status)) {
                    stopLogPolling();
                    document.getElementById('stopTaskBtn').style.display = 'none';
                    if (data.status === 'SUCCESS') {
                        addLogLine('任务执行完成！', 'info');
                        setTimeout(() => {
                            location.reload();
                        }, 3000);
                    }
                } else if (['STARTED', 'PROGRESS'].includes(data.status)) {
                    // 显示停止按钮
                    document.getElementById('stopTaskBtn').style.display = 'inline-block';
                }
            }
        }
    })
    .catch(error => {
        console.error('获取日志失败:', error);
        addLogLine('获取日志失败: ' + error.message, 'error');
    });
}

/**
 * 停止日志轮询
 */
function stopLogPolling() {
    if (logPollingInterval) {
        clearInterval(logPollingInterval);
        logPollingInterval = null;
    }
}

/**
 * AI生成章节功能
 */
function generateChapters() {
    showAIStatus('loading', 'AI正在生成章节结构...');
    
    setTimeout(() => {
        fetch('/api/ai/generate-chapters/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                 novel_id: '{{ novel.id }}',
                 action: 'generate_chapters'
             })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAIStatus('success', '章节生成完成！');
                setTimeout(() => location.reload(), 2000);
            } else {
                showAIStatus('error', data.message || '章节生成失败');
            }
        })
        .catch(error => {
            showAIStatus('error', '网络错误，请稍后重试');
            console.error('Error:', error);
        });
    }, 500);
}

/**
 * AI生成摘要功能
 */
function generateSummary() {
    showAIStatus('loading', 'AI正在生成小说摘要...');
    
    setTimeout(() => {
        fetch('/api/ai/generate-summary/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                 novel_id: '{{ novel.id }}',
                 action: 'generate_summary'
             })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAIStatus('success', '摘要生成完成！');
                setTimeout(() => location.reload(), 2000);
            } else {
                showAIStatus('error', data.message || '摘要生成失败');
            }
        })
        .catch(error => {
            showAIStatus('error', '网络错误，请稍后重试');
            console.error('Error:', error);
        });
    }, 500);
}

/**
 * AI校验解说文案功能
 */
function validateNarration() {
    showAIStatus('loading', 'AI正在校验解说文案...');
    
    fetch('/video/novels/{{ novel.id }}/validate-narration/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
             novel_id: '{{ novel.id }}',
             action: 'validate_narration'
         })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAIStatus('success', '解说文案校验完成！' + (data.message || ''));
        } else {
            showAIStatus('error', data.message || '解说文案校验失败');
        }
    })
    .catch(error => {
        showAIStatus('error', '网络错误，请稍后重试');
        console.error('Error:', error);
    });
}

/**
 * AI逻辑检查功能
 */
function validateLogic() {
    showAIStatus('loading', 'AI正在检查逻辑一致性...');
    
    setTimeout(() => {
        fetch('/api/ai/validate-logic/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                 novel_id: '{{ novel.id }}',
                 action: 'validate_logic'
             })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAIStatus('success', '逻辑检查完成！' + (data.issues ? '发现 ' + data.issues + ' 个问题' : '逻辑一致'));
            } else {
                showAIStatus('error', data.message || '逻辑检查失败');
            }
        })
        .catch(error => {
            showAIStatus('error', '网络错误，请稍后重试');
            console.error('Error:', error);
        });
    }, 500);
}

/**
 * AI语言检查功能
 */
function validateLanguage() {
    showAIStatus('loading', 'AI正在检查语言规范...');
    
    setTimeout(() => {
        fetch('/api/ai/validate-language/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                 novel_id: '{{ novel.id }}',
                 action: 'validate_language'
             })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAIStatus('success', '语言检查完成！' + (data.errors ? '发现 ' + data.errors + ' 个错误' : '语言规范'));
            } else {
                showAIStatus('error', data.message || '语言检查失败');
            }
        })
        .catch(error => {
            showAIStatus('error', '网络错误，请稍后重试');
            console.error('Error:', error);
        });
    }, 500);
}

/**
 * 更新解说文案按钮状态
 * @param {string} taskStatus - 任务状态
 */
function updateScriptButtonState(taskStatus) {
    const button = document.querySelector('button[onclick="generateScript()"]');
    if (!button) return;
    
    if (taskStatus === 'generating_script') {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>生成中...';
    } else {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-wand-magic-sparkles me-2"></i>生成解说文案';
    }
}

/**
 * 开始轮询任务状态
 */
function startTaskStatusPolling() {
    const pollInterval = setInterval(() => {
        fetch('/video/novels/{{ novel.id }}/task-status/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            updateScriptButtonState(data.task_status);
            
            // 如果任务完成，停止轮询并刷新页面
             if (data.task_status === 'script_completed' || data.task_status === 'script_failed') {
                 clearInterval(pollInterval);
                 if (data.task_status === 'script_completed') {
                     showAIStatus('success', '解说文案生成完成！');
                     setTimeout(() => location.reload(), 2000);
                 } else {
                     showAIStatus('error', data.task_message || '解说文案生成失败');
                 }
             }
        })
        .catch(error => {
            console.error('轮询任务状态失败:', error);
            clearInterval(pollInterval);
        });
    }, 3000); // 每3秒轮询一次
}

/**
 * 页面加载时检查任务状态
 */
document.addEventListener('DOMContentLoaded', function() {
    // 初始化任务组件
    if (typeof initTaskComponents === 'function') {
        initTaskComponents();
    }
    
    // 检查当前任务状态
    fetch('/video/novels/{{ novel.id }}/task-status/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        updateScriptButtonState(data.task_status);
        
        // 如果有任务正在进行，开始轮询
        if (data.task_status === 'generating_script') {
            showAIStatus('loading', 'AI正在生成解说文案...');
            startTaskStatusPolling();
        }
    })
    .catch(error => {
        console.error('检查任务状态失败:', error);
    });
    
    // 绑定日志模态框事件
    const clearLogBtn = document.getElementById('clearLogBtn');
    const pauseLogBtn = document.getElementById('pauseLogBtn');
    const stopTaskBtn = document.getElementById('stopTaskBtn');
    
    if (clearLogBtn) {
        clearLogBtn.addEventListener('click', function() {
            document.getElementById('logContent').innerHTML = '<div class="log-line text-muted">日志已清空</div>';
        });
    }
    
    if (pauseLogBtn) {
        pauseLogBtn.addEventListener('click', function() {
            isPaused = !isPaused;
            this.textContent = isPaused ? '继续刷新' : '暂停刷新';
            this.className = isPaused ? 'btn btn-sm btn-outline-success' : 'btn btn-sm btn-outline-primary';
        });
    }
    
    if (stopTaskBtn) {
        stopTaskBtn.addEventListener('click', function() {
            if (currentTaskId && confirm('确定要停止当前任务吗？')) {
                fetch('/video/novels/{{ novel.id }}/stop-task/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        task_id: currentTaskId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLogLine('任务停止请求已发送', 'warning');
                        updateTaskStatus('停止中', 'bg-warning');
                    } else {
                        addLogLine('停止任务失败: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    addLogLine('停止任务请求失败: ' + error.message, 'error');
                });
            }
        });
    }
});

/**
 * 获取CSRF Token
 * @param {string} name - Cookie名称
 * @returns {string} Cookie值
 */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">小说详情</h5>
                <div>
                    <a href="{% url 'video:novel_list' %}" class="btn btn-light btn-sm">返回列表</a>
                    <a href="{% url 'admin:video_novel_change' novel.id %}" class="btn btn-warning btn-sm">编辑</a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4>基本信息</h4>
                        <table class="table">
                            <tr>
                                <th style="width: 150px;">ID</th>
                                <td>{{ novel.id }}</td>
                            </tr>
                            <tr>
                                <th>名称</th>
                                <td>{{ novel.name }}</td>
                            </tr>
                            <tr>
                                <th>字数</th>
                                <td>{{ novel.word_count }}</td>
                            </tr>
                            <tr>
                                <th>类型</th>
                                <td>{{ novel.type }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h4>统计信息</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h5>章节数</h5>
                                        <h2>{{ chapters.count }}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h5>总字数</h5>
                                        <h2>{{ novel.word_count }}</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI操作区域 -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-gradient text-white d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h5 class="card-title mb-0">
                    <i class="fas fa-robot me-2"></i>AI操作中心
                </h5>
                <small class="text-white-50">智能生成与校验</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-primary h-100">
                            <div class="card-header bg-primary text-white">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-magic me-2"></i>AI生成
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text text-muted">使用AI技术自动生成解说文案，带检查功能</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="generateScript()">
                                        <i class="fas fa-wand-magic-sparkles me-2"></i>生成解说文案
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="showTaskLogModal()">
                                        <i class="fas fa-terminal me-2"></i>查看任务日志
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success h-100">
                            <div class="card-header bg-success text-white">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-check-circle me-2"></i>AI校验
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text text-muted">验证解说文案字数，自动修复格式问题</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="showAIValidationModal()">
                                        <i class="fas fa-cogs me-2"></i>AI智能校验
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI操作状态显示 -->
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="alert alert-info d-none" id="ai-status">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span id="ai-status-text">AI正在处理中...</span>
                            </div>
                        </div>
                        <div class="alert alert-success d-none" id="ai-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="ai-success-text">操作完成</span>
                        </div>
                        <div class="alert alert-danger d-none" id="ai-error">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="ai-error-text">操作失败</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">章节列表</h5>
                <a href="{% url 'admin:video_chapter_add' %}" class="btn btn-light btn-sm">添加章节</a>
            </div>
            <div class="card-body">
                {% if chapters %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>章节名</th>
                                <th>字数</th>
                                <th>风格</th>
                                <th>解说数</th>
                                <th>视频状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for chapter in chapters %}
                            <tr>
                                <td>{{ chapter.id }}</td>
                                <td>{{ chapter.title }}</td>
                                <td>{{ chapter.word_count }}</td>
                                <td>{{ chapter.format }}</td>
                                <td>{{ chapter.narrations.count }}</td>
                                <td>
                                    {% if chapter.video_path %}
                                    <span class="badge bg-success">已生成</span>
                                    {% else %}
                                    <span class="badge bg-warning">未生成</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'video:chapter_detail' chapter.id %}" class="btn btn-info btn-sm">查看</a>
                                    <a href="{% url 'admin:video_chapter_change' chapter.id %}" class="btn btn-warning btn-sm">编辑</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">该小说暂无章节数据</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- AI校验模态框 - 使用统一任务组件 -->
<div class="modal fade" id="aiValidationModal" tabindex="-1" aria-labelledby="aiValidationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiValidationModalLabel">
                    <i class="fas fa-cogs me-2"></i>AI智能校验 - {{ novel.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="aiValidationForm">
                    {% csrf_token %}
                    
                    <!-- 校验选项 -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-list-check me-2"></i>校验选项
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="check_closeup_length" name="check_closeup_length" value="true" checked>
                                    <label class="form-check-label" for="check_closeup_length">
                                        <strong>特写解说字数校验</strong>
                                    </label>
                                    <div class="form-text">检查分镜1中第一个和第二个图片特写的解说内容字数，确保控制在30-32字之间</div>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="check_total_length" name="check_total_length" value="true" checked>
                                    <label class="form-check-label" for="check_total_length">
                                        <strong>总解说字数校验</strong>
                                    </label>
                                    <div class="form-text">检查整个章节的解说内容总字数，确保控制在1300-1700字之间</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="auto_rewrite" name="auto_rewrite" value="true" checked>
                                    <label class="form-check-label" for="auto_rewrite">
                                        <strong>自动改写解说内容</strong>
                                    </label>
                                    <div class="form-text">当解说内容字数不符合要求时，自动调用AI模型进行改写，确保字数符合标准</div>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="auto_fix_characters" name="auto_fix_characters" value="true" checked>
                                    <label class="form-check-label" for="auto_fix_characters">
                                        <strong>自动修复角色定义</strong>
                                    </label>
                                    <div class="form-text">检查特写人物是否在出镜人物列表中，自动生成缺失角色的定义信息</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="auto_fix_tags" name="auto_fix_tags" value="true" checked>
                                    <label class="form-check-label" for="auto_fix_tags">
                                        <strong>自动修复XML标签</strong>
                                    </label>
                                    <div class="form-text">检查并修复narration.txt文件中的XML标签闭合问题，确保格式正确</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 使用统一任务状态组件 -->
                    <div id="aiValidationTaskContainer">
                        {% include 'components/task-components.html' %}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div>
                        <small class="text-muted">任务ID: <span id="currentValidationTaskId">-</span></small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-success" id="startValidationBtn" onclick="executeAIValidation()">
                            <i class="fas fa-play me-2"></i>开始校验
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 解说文案生成参数配置模态框 - 使用统一任务组件 -->
<div class="modal fade" id="scriptParametersModal" tabindex="-1" aria-labelledby="scriptParametersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scriptParametersModalLabel">
                    <i class="fas fa-file-text me-2"></i>解说文案生成参数配置
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="scriptParametersForm">
                    {% csrf_token %}
                    
                    <!-- 基础参数 -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-cog me-2"></i>基础参数
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="chapters" class="form-label">生成章节数</label>
                                    <input type="number" class="form-control" id="chapters" name="chapters" value="50" min="1" max="200" required>
                                    <div class="form-text">要生成的章节数量，默认50章</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="limit" class="form-label">限制章节数</label>
                                    <input type="number" class="form-control" id="limit" name="limit" placeholder="不限制">
                                    <div class="form-text">限制处理的章节数量，留空表示不限制</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="workers" class="form-label">并发工作数</label>
                                    <input type="number" class="form-control" id="workers" name="workers" value="5" min="1" max="20" required>
                                    <div class="form-text">并发处理的工作线程数，默认5</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_retries" class="form-label">最大重试次数</label>
                                    <input type="number" class="form-control" id="max_retries" name="max_retries" value="3" min="1" max="10" required>
                                    <div class="form-text">生成失败时的最大重试次数，默认3次</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 内容参数 -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-text-width me-2"></i>内容参数
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="min_length" class="form-label">最小长度</label>
                                    <input type="number" class="form-control" id="min_length" name="min_length" value="1200" min="500" max="3000" required>
                                    <div class="form-text">解说文案的最小字符数，默认1200</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_length" class="form-label">最大长度</label>
                                    <input type="number" class="form-control" id="max_length" name="max_length" value="1700" min="1000" max="5000" required>
                                    <div class="form-text">解说文案的最大字符数，默认1700</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 执行选项 -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-play-circle me-2"></i>执行选项
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="validate_only" name="validate_only">
                                    <label class="form-check-label" for="validate_only">
                                        <strong>仅验证模式</strong>
                                    </label>
                                    <div class="form-text">只验证现有文案，不生成新内容</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="regenerate" name="regenerate">
                                    <label class="form-check-label" for="regenerate">
                                        <strong>强制重新生成</strong>
                                    </label>
                                    <div class="form-text">重新生成已存在的解说文案</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 使用统一任务状态组件 -->
                    <div id="scriptGenerationTaskContainer">
                        {% include 'components/task-components.html' %}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div>
                        <small class="text-muted">任务ID: <span id="currentScriptTaskId">-</span></small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="startScriptGenerationBtn" onclick="executeScriptGeneration()">
                            <i class="fas fa-play me-2"></i>开始生成
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 使用统一的任务组件 -->
{% include 'components/task-components.html' %}

{% endblock %}