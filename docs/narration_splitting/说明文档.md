# Narration文件按人物特写拆分功能

## 项目概述

本功能为 `validate_narration.py` 脚本新增了按人物特写拆分 `narration.txt` 文件的能力。在完成内容验证后，自动将每个章节的narration文件按照人物特写维度拆分成独立的txt文件，并将人物描述信息融合到图片prompt中。

## 功能特性

### 1. 人物描述提取
- 从 `narration.txt` 文件中提取所有角色的详细描述信息
- 包括：性别、年龄段、外貌特征（头发、面部、身材）、服装风格（上衣、下装）
- 支持多角色同时提取和管理

### 2. 图片特写拆分
- 按照分镜和图片特写的结构进行文件拆分
- 每个特写生成一个独立的txt文件
- 文件命名格式：`closeup_{编号}_{人物姓名}.txt`

### 3. 人物描述融合
- 智能识别图片prompt中提到的人物
- 将对应的人物描述信息融合到prompt中
- 保持原始prompt内容的完整性

## 使用方法

### 基本用法
```bash
python validate_narration.py data/025
```

### 功能说明
- 脚本会首先执行原有的narration验证功能
- 验证完成后自动执行文件拆分功能
- 拆分结果会显示在控制台输出中

### 输出示例
```
================================================================================
开始按人物特写拆分narration.txt文件...

处理章节: chapter_001
  ✓ 成功拆分 12 个人物特写
  ✓ 发现 3 个人物描述
  ✓ 创建文件: closeup_001_吴双.txt, closeup_002_吴双.txt, ...

================================================================================
拆分完成!
处理章节数: 10
创建文件数: 162
总特写数量: 162
所有章节都成功完成拆分！
```

## 输出文件格式

每个拆分后的文件包含以下内容：

```
特写人物: 吴双
解说内容: 吴家主院清晨，吴双低头疾走,眉紧盯下腹金涡旋,无声,风雷唯他能闻。
原始图片prompt: 古风言情风格，宋代庭院清晨，少年吴双低头行走...
增强图片prompt: 古风言情风格，宋代庭院清晨，少年吴双（性别：男，年龄：31-45岁，头发：黑色束发...）低头行走...

=== 分镜信息 ===
分镜编号: 1
特写编号: 1
```

## 技术实现

### 核心函数

1. **extract_character_descriptions(content)**
   - 提取人物描述信息
   - 解析XML格式的角色定义
   - 返回结构化的人物描述字典

2. **merge_character_description_to_prompt(prompt, character_name, character_descriptions)**
   - 将人物描述融合到图片prompt中
   - 智能识别prompt中的人物引用
   - 保持原始prompt的可读性

3. **split_narration_by_closeups(narration_file_path, output_dir=None)**
   - 主要的文件拆分函数
   - 解析分镜和图片特写结构
   - 生成独立的特写文件

### XML标签支持

支持以下XML标签格式：
- 角色定义：`<角色1>`, `<角色2>`, ...
- 角色信息：`<角色姓名>`, `<性别>`, `<年龄段>`, `<外貌特征>`, `<服装风格>`
- 分镜结构：`<分镜1>`, `<分镜2>`, ...
- 图片特写：`<图片特写1>`, `<图片特写2>`, ...
- 特写内容：`<特写人物>`, `<解说内容>`, `<图片prompt>`

## 项目规划

### 已完成功能 ✅
- [x] 分析现有的 `validate_narration.py` 文件结构
- [x] 分析 `narration.txt` 文件格式
- [x] 设计人物描述提取和融合算法
- [x] 实现按人物特写拆分文件的核心功能
- [x] 集成到主工作流程中
- [x] 测试功能并验证输出文件正确性

### 实施方案

1. **需求分析阶段**
   - 理解现有项目结构和代码规范
   - 分析narration.txt文件的XML格式
   - 确定人物描述提取和prompt融合的策略

2. **功能开发阶段**
   - 实现人物描述提取函数
   - 实现prompt融合算法
   - 实现文件拆分主功能
   - 集成到现有验证流程

3. **测试验证阶段**
   - 使用data/025目录进行功能测试
   - 验证生成文件的格式和内容正确性
   - 确认人物描述融合效果

## 进度记录

- **2024-01-XX**: 项目启动，完成需求分析
- **2024-01-XX**: 完成核心功能开发
- **2024-01-XX**: 完成功能集成和测试
- **2024-01-XX**: 项目交付，生成162个特写文件

## 注意事项

1. **文件覆盖**: 重复运行会覆盖已存在的特写文件
2. **XML格式**: 依赖于标准的XML标签格式，格式错误可能导致解析失败
3. **字符编码**: 确保文件使用UTF-8编码以正确处理中文字符
4. **目录权限**: 确保对目标目录有写入权限

## 错误处理

- 文件读取失败时会跳过该章节并记录错误
- XML解析失败时会继续处理其他内容
- 人物描述缺失时使用原始prompt

## 扩展可能

- 支持更多的XML标签格式
- 添加图片prompt的质量检查
- 支持批量处理多个数据目录
- 添加更详细的日志记录功能