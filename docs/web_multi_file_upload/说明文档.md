# Web系统多文件上传功能

## 项目概述

本功能为Web管理界面的"添加小说"功能增强为多文件上传模式。用户可以一次性选择并上传多个小说文件（.txt, .doc, .docx, .pdf），系统将批量处理并创建多个小说记录。

## 功能特性

### 1. 多文件选择
- 支持一次性选择多个文件进行上传
- 支持的文件格式：.txt, .doc, .docx, .pdf
- 实时显示已选择的文件列表
- 支持单个文件移除功能
- 显示每个文件的大小信息

### 2. 批量上传处理
- 依次上传每个文件到服务器
- 为每个文件显示独立的上传进度条
- 实时更新每个文件的上传状态（等待、上传中、成功、失败）
- 自动提取文件内容和计算字数
- 从文件名自动获取小说名称

### 3. 上传结果反馈
- 上传完成后显示详细的结果摘要
- 统计成功和失败的文件数量
- 对于失败的文件，显示具体的错误信息
- 上传成功后自动刷新页面显示新添加的小说

## 界面展示

### 文件选择界面
```
┌─────────────────────────────────────┐
│          添加小说                    │
├─────────────────────────────────────┤
│ 上传文件：                           │
│ [选择文件] 未选择任何文件            │
│                                     │
│ 已选择的文件：                       │
│ ┌─────────────────────────────────┐ │
│ │ 📄 小说1.txt (125 KB)    [✗]   │ │
│ │ 📄 小说2.txt (98 KB)     [✗]   │ │
│ │ 📄 小说3.doc (256 KB)    [✗]   │ │
│ └─────────────────────────────────┘ │
│                                     │
│          [取消]    [创建]           │
└─────────────────────────────────────┘
```

### 上传进度界面
```
┌─────────────────────────────────────┐
│          添加小说                    │
├─────────────────────────────────────┤
│ 上传进度：                           │
│                                     │
│ 小说1.txt            上传成功 ✓     │
│ ████████████████████████ 100%      │
│                                     │
│ 小说2.txt            上传中...      │
│ ████████████         50%           │
│                                     │
│ 小说3.doc            等待上传...    │
│                      0%             │
│                                     │
│          [取消]    [上传中...]      │
└─────────────────────────────────────┘
```

## 使用方法

### 基本用法
1. 在小说列表页面点击"添加小说"按钮
2. 在弹出的对话框中点击"选择文件"按钮
3. 在文件选择器中按住Ctrl（Windows）或Cmd（Mac）键选择多个文件
4. 确认选择后，文件列表会显示在界面上
5. 可以点击文件后面的[✗]按钮移除不需要的文件
6. 点击"创建"按钮开始上传
7. 系统会依次上传每个文件，并显示实时进度
8. 上传完成后会显示结果摘要
9. 成功上传的小说会自动显示在列表中

### 结果摘要示例
```
上传完成！
成功: 2 个
失败: 1 个

失败的文件：
- 小说3.doc: 文件处理失败: 不支持的文件格式
```

## 技术实现

### 前端实现

#### 1. HTML结构变更
- 将文件输入框的`name`从`original_file`改为`original_files`
- 添加`multiple`属性支持多文件选择
- 将模态框大小从`modal-dialog`改为`modal-lg`以容纳更多内容
- 新增文件列表展示区域（`fileListContainer`）
- 新增上传进度展示区域（`uploadProgressContainer`）

#### 2. JavaScript功能

**文件选择监听器**
```javascript
document.getElementById('id_original_files').addEventListener('change', function(e) {
    // 监听文件选择事件
    // 显示已选择的文件列表
    // 显示每个文件的名称和大小
    // 添加移除按钮
});
```

**文件大小格式化**
```javascript
function formatFileSize(bytes) {
    // 将字节数转换为易读的格式
    // 支持 Bytes, KB, MB, GB
}
```

**文件移除功能**
```javascript
function removeFile(indexToRemove) {
    // 使用DataTransfer API重建FileList
    // 移除指定索引的文件
    // 重新触发change事件更新显示
}
```

**表单提交处理**
```javascript
document.getElementById('createNovelForm').addEventListener('submit', async function(e) {
    // 阻止默认提交行为
    // 为每个文件创建独立的进度条
    // 依次上传每个文件
    // 更新每个文件的上传状态
    // 统计成功和失败数量
    // 显示最终结果摘要
});
```

### 后端实现

#### 视图函数保持不变
后端的`NovelCreateView`视图函数无需修改，因为：
- 前端通过循环依次上传单个文件
- 每次请求仍然只包含一个文件
- 保持了与现有API的兼容性

#### 处理流程
1. 前端提交FormData，包含单个文件和CSRF token
2. 后端接收文件，提取文件名和内容
3. 自动生成小说名称（去掉扩展名）
4. 计算字数并判断小说类型
5. 保存到数据库并上传到TOS
6. 返回JSON响应（包含success、message、novel_id等）

## 文件结构

```
web/
├── templates/
│   └── video/
│       └── novel_list.html          # 小说列表页面（已修改）
├── video/
│   ├── views.py                     # 视图函数（无需修改）
│   ├── forms.py                     # 表单定义（无需修改）
│   └── models.py                    # 数据模型（无需修改）
└── static/
    └── ...
```

## 项目规划

### 已完成功能 ✅
- [x] 分析现有的小说上传功能
- [x] 设计多文件上传的前端界面
- [x] 实现文件列表展示和管理
- [x] 实现批量上传和进度跟踪
- [x] 实现文件移除功能
- [x] 集成到现有的小说管理系统
- [x] 测试功能并验证正确性

### 实施方案

1. **需求分析阶段**
   - 理解现有的单文件上传流程
   - 分析多文件上传的技术可行性
   - 设计用户交互流程

2. **功能开发阶段**
   - 修改HTML模板支持多文件选择
   - 实现文件列表展示组件
   - 实现批量上传逻辑
   - 实现进度跟踪和状态管理
   - 实现结果统计和反馈

3. **测试验证阶段**
   - 测试多文件选择功能
   - 测试文件移除功能
   - 测试批量上传流程
   - 验证错误处理机制
   - 确认界面响应和用户体验

## 进度记录

- **2025-11-05**: 项目启动，完成需求分析
- **2025-11-05**: 完成前端HTML和JavaScript开发
- **2025-11-05**: 完成功能集成和测试
- **2025-11-05**: 项目交付，功能正常运行

## 注意事项

1. **浏览器兼容性**: DataTransfer API在部分旧版浏览器中可能不支持
2. **文件大小限制**: 应考虑服务器和网络对单个文件和总文件大小的限制
3. **并发控制**: 当前实现是串行上传，如需提高速度可考虑并行上传
4. **错误处理**: 确保对各种上传失败情况都有适当的错误提示
5. **用户体验**: 上传大量文件时需要考虑超时和用户等待体验

## 性能优化建议

### 当前实现
- 串行上传：依次上传每个文件，简单可靠但速度较慢
- 适合文件数量较少（<10个）的场景

### 优化方向
1. **并行上传**
   - 同时上传多个文件（如3-5个）
   - 需要控制并发数量避免服务器压力过大
   
2. **分片上传**
   - 对于大文件进行分片上传
   - 支持断点续传
   
3. **压缩优化**
   - 前端对文本文件进行压缩后上传
   - 减少网络传输时间

## 扩展可能

- 支持拖放上传（Drag & Drop）
- 支持文件预览功能
- 添加文件类型和大小验证
- 支持上传队列管理
- 添加上传速度显示
- 支持取消单个文件上传
- 添加重试失败文件的功能

## 相关文件

- `/Users/xunan/Projects/wrmVideo/web/templates/video/novel_list.html` - 前端模板文件
- `/Users/xunan/Projects/wrmVideo/web/video/views.py` - 后端视图函数
- `/Users/xunan/Projects/wrmVideo/web/video/forms.py` - 表单定义
- `/Users/xunan/Projects/wrmVideo/web/video/models.py` - 数据模型

## 技术栈

- **前端**: HTML5, JavaScript (ES6+), Bootstrap 5
- **后端**: Django, Python
- **API**: RESTful API (JSON格式)
- **浏览器API**: File API, FormData, Fetch API, DataTransfer API

## 更新历史

### v1.1.0 (2025-11-05)
- 📋 **列表界面优化**: 简化小说列表显示
  - 移除字数、类型、章节数、更新时间列
  - 只保留：复选框、ID、名称、创建时间、AI处理、操作
  - 创建时间使用简化格式（Y-m-d H:i）
- ✅ **批量操作功能**: 新增批量AI处理功能
  - 全选/取消全选功能（顶部和表头两个位置）
  - 批量AI生成按钮（选择后启用）
  - 批量AI校验按钮（选择后启用）
  - 单个复选框联动全选状态
  - 批量处理进度跟踪和结果统计
  - 详细的成功/失败信息反馈

### v1.0.0 (2025-11-05)
- ✨ 初始版本发布
- 🎯 支持多文件选择和上传
- 📊 实时进度跟踪
- 📝 详细的结果反馈

